{{/* This form now handles both creating and editing */}}

{{/* Set the correct action based on whether we are editing or creating */}}
{{ $isEdit := .User.ID }}
{{ $actionURL := "/admin/users" }}
{{ if $isEdit }}
{{ $actionURL = printf "/admin/users/%d" .User.ID }}
{{ end }}

<form
 {{ if $isEdit }}
    hx-put="{{ $actionURL }}" 
    hx-target="#user-row-{{ .User.ID }}" 
    hx-swap="outerHTML" 
 {{ else }}
    hx-post="{{ $actionURL }}" 
    hx-target="#users-table-body" 
    hx-swap="beforeend" 
{{ end }}
    hx-on="htmx:afterOnLoad: this.closest('.modal').querySelector('[data-bs-dismiss]').click()">

    <div class="modal-header">
        <h5 class="modal-title">{{ if $isEdit }}Edit User{{ else }}Add New User{{ end }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
    </div>
<div class="modal-body">
    <div class="mb-3">
        <label for="userName" class="form-label">User Name</label>
        <input type="text" class="form-control" name="userName" required value="{{ .User.UserName }}">
    </div>
    <div class="mb-3">
        <label for="email" class="form-label">Email</label>
        <input type="email" class="form-control" name="email" required value="{{ .User.Email }}">
    </div>
    <div class="mb-3">
        <label for="password" class="form-label">{{ if $isEdit }}New Password (leave blank to keep current){{ else
            }}Password{{ end }}</label>
        <input type="password" class="form-control" name="password" {{ if not $isEdit }}required{{ end }}>
    </div>

    <div class="mb-3">
        <label for="role" class="form-label">User Role</label>
        <select class="form-select" name="role" required>
            {{ range .Roles }}
            <option value="{{ . }}" {{ if eq . $.User.Role }}selected{{ end }}>{{ . }}</option>
            {{ end }}
        </select>
    </div>
</div>
    <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
    </div>
</form>